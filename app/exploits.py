import os
import time
import html
import flask
import shutil
import base64
import subprocess


import db
import log
import targets
import settings
import submitter
import flagformat

# Helper functions
def load_exploits():
    for exploit in os.listdir(settings.EXPLOITS_DIR):
        if exploit != "templates" and exploit != "archive":
            # Check if exploit path already exists in database
            found = False
            for e in db.data["exploits"].values():
                if e["path"] == exploit:
                    found = True
                    break
            if found:
                continue
            id = str(next(db.id_iter))
            name = exploit
            db.data["exploits"][id] = {
                "id": int(id),
                "name": name,
                "frequency": settings.EXPLOIT_DEFAULT_FREQUENCY,
                "path": name,
                "flags_captured": 0,
                "services_vulnerable": 0,
                "log": {}
            }

def get_file_contents(filename):
    # Get the contents of a template file
    with open(os.path.join(filename), "r") as f:
        return f.read()

def get_exploit_templates():
    return os.listdir(settings.EXPLOITS_TEMPLATES_DIR)

def get_archived_exploits():
    return os.listdir(settings.EXPLOITS_ARCHIVE_DIR)

def run_exploit_on_target(id, target):
    exploit = db.data["exploits"][id]
    exploit_path = os.path.join(settings.EXPLOITS_DIR, exploit["path"])
    os.system("chmod +x " + exploit_path)
    output = subprocess.check_output(exploit_path + " " + target["ip"], shell=True)
    # Parse output for flags
    submitter.handle_data(id, target["teamid"], target["serviceid"], output.decode("utf-8"))
    # HTML encode output
    output = html.escape(output.decode("utf-8"))
    # Get pretty timestamp
    timestamp = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())
    # Add to log
    log.log_exploit(id, timestamp, target["team"], target["service"], target["ip"], "success", output)
    print("Ran exploit " + exploit["name"] + " on " + target["ip"])
    


# Frontend views
def view_exploits():
    exploits = db.data["exploits"]
    return flask.render_template("exploits/index.html", exploits=exploits)

def view_archived_exploits():
    exploits = get_archived_exploits()
    return flask.render_template("exploits/archived.html", exploits=exploits)

def view_new_exploit():
    template = flask.request.args.get("template")
    templates = get_exploit_templates()
    if template:
        code = get_file_contents(os.path.join(settings.EXPLOITS_TEMPLATES_DIR, template))
        return flask.render_template("exploits/new.html", templates = templates, code = code, messages = ["Loaded template " + template])
    else:
        return flask.render_template("exploits/new.html", templates = templates, code = "")

def view_modify_exploit():
    id = flask.request.args.get("id")
    try:
        exploit = db.data["exploits"][id]
        code = get_file_contents(os.path.join(settings.EXPLOITS_DIR, exploit["path"]))
        return flask.render_template("exploits/modify.html", exploit = exploit, code = code)
    except KeyError:
        return flask.render_template("404.html")

def view_exploit_log():
    id = flask.request.args.get("id")
    try:
        l = log.get_exploit_log(id)
    except KeyError:
        l = {}
    return flask.render_template("exploits/log.html", log = l, id = id)

def view_exploit_log_details():
    id = flask.request.args.get("exploit")
    timestamp = flask.request.args.get("timestamp")
    try:
        item = log.get_exploit_log_details(id, timestamp)
        return flask.render_template("exploits/details.html", item = item, id = id)
    except KeyError:
        return flask.render_template("404.html")


# Backened functions
def create_exploit():
    name = flask.request.form.get("name")
    code = flask.request.form.get("code")
    frequency = flask.request.form.get("frequency")

    name = name.strip('.').strip('/')

    id = str(next(db.id_iter))

    path = name

    # Check if the exploit already exists
    if os.path.exists(os.path.join(settings.EXPLOITS_DIR, path)):
        exists_counter = 1
        while os.path.exists(os.path.join(settings.EXPLOITS_DIR, path + "_" + str(exists_counter))):
            exists_counter += 1
        path = path + "_" + str(exists_counter)

    db.data["exploits"][id] = {
        "id": int(id),
        "name": name,
        "frequency": frequency,
        "path": path,
        "flags_captured": 0,
        "services_vulnerable": 0,
        "log": {}
    }

    with open(os.path.join(settings.EXPLOITS_DIR, path), "w", newline='\n') as f:
        code = code.replace('\r', '')
        f.write(code)

    return flask.redirect("/exploits")

def update_exploit():
    name = flask.request.form.get("name")
    code = flask.request.form.get("code")
    frequency = flask.request.form.get("frequency")
    id = flask.request.form.get("id")

    old_path = db.data["exploits"][id]["path"]
    path = name

    if old_path != path:
    # Check if the exploit already exists
        if os.path.exists(os.path.join(settings.EXPLOITS_DIR, path)):
            exists_counter = 1
            while os.path.exists(os.path.join(settings.EXPLOITS_DIR, path + "_" + str(exists_counter))):
                exists_counter += 1
            path = path + "_" + str(exists_counter)

    # Delete the old file
    os.remove(os.path.join(settings.EXPLOITS_DIR, old_path))
    # Write the new file
    with open(os.path.join(settings.EXPLOITS_DIR, path), "w", newline='\n') as f:
        code = code.replace('\r', '')
        f.write(code)

    db.data["exploits"][id]["name"] = name
    db.data["exploits"][id]["frequency"] = frequency
    db.data["exploits"][id]["path"] = path


    return flask.redirect("/exploits")

def archive_exploit():
    id = flask.request.args.get("id")

    try:
        path = db.data["exploits"][id]["path"]
    except KeyError:
        return flask.render_template("404.html")

    shutil.move(os.path.join(settings.EXPLOITS_DIR, path), os.path.join(settings.EXPLOITS_ARCHIVE_DIR, path))
    
    del db.data["exploits"][id]

    return flask.redirect("/exploits")


def unarchive_exploit():
    name = flask.request.args.get("name")

    try:
        id = str(next(db.id_iter))
        path = name
        shutil.move(os.path.join(settings.EXPLOITS_ARCHIVE_DIR, name), os.path.join(settings.EXPLOITS_DIR, path))
        db.data["exploits"][id] = {
            "id": int(id),
            "name": path,
            "frequency": settings.EXPLOIT_DEFAULT_FREQUENCY,
            "path": path,
            "flags_captured": 0,
            "services_vulnerable": 0,
            "log": {}
        }
    except Exception:
        return flask.render_template("404.html")

    return flask.redirect("/exploits")

def delete_exploit():
    name = flask.request.args.get("name")

    try:
        os.remove(os.path.join(settings.EXPLOITS_ARCHIVE_DIR, name))
    except Exception:
        return flask.render_template("404.html")

    return flask.redirect("/exploits/archived")

def run_exploit():
    id = flask.request.args.get("id")

    try:        
        for target in targets.list_targets().values():
            run_exploit_on_target(id, target)

        return flask.redirect("/exploits/log?id=" + id)
    except KeyError:
        return flask.render_template("404.html")
    


    